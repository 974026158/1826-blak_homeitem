"use strict";var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){var s=42,a=10,c=310,u=155,r=Math.PI,l=62;function t(e,t){return Math.round(Math.random()*(t-e)+e)}function d(e){return document.createElement(e)}function h(e,t){e.classList.add(t)}function o(){return"https://picsum.photos/300/150/?image="+t(0,100)}function i(e,t,i,n){e.beginPath(),e.moveTo(i,n),e.lineTo(i+21,n),e.arc(i+21,n-a+2,a,0,2*r),e.lineTo(i+21,n),e.lineTo(i+s,n),e.lineTo(i+s,n+21),e.arc(i+s+a-2,n+21,a,0,2*r),e.lineTo(i+s,n+21),e.lineTo(i+s,n+s),e.lineTo(i,n+s),e.lineTo(i,n),e.fillStyle="#fff",e[t](),e.beginPath(),e.arc(i,n+21,a,1.5*r,.5*r),e.globalCompositeOperation="xor",e.fill()}function f(e,t){return e+t}function v(e){return e*e}var n=function(){function n(e,t,i){_classCallCheck(this,n),this.el=e,this.success=t,this.fail=i}return _createClass(n,[{key:"init",value:function(){this.initDOM(),this.initImg(),this.draw(),this.bindEvents()}},{key:"initDOM",value:function(){var e=function(e,t){var i=d("canvas");return i.width=e,i.height=t,i}(c,u),t=e.cloneNode(!0),i=d("div"),n=d("div"),s=d("div"),a=d("div"),r=d("span"),l=d("span");t.className="block",i.className="sliderContainer",n.className="refreshIcon",s.className="sliderMask",a.className="slider",r.className="sliderIcon",l.innerHTML="向右滑动滑块填充拼图",l.className="sliderText";var o=this.el;o.appendChild(e),o.appendChild(n),o.appendChild(t),a.appendChild(r),s.appendChild(a),i.appendChild(s),i.appendChild(l),o.appendChild(i),Object.assign(this,{canvas:e,block:t,sliderContainer:i,refreshIcon:n,slider:a,sliderMask:s,sliderIcon:r,text:l,canvasCtx:e.getContext("2d"),blockCtx:t.getContext("2d")})}},{key:"initImg",value:function(){var i=this,n=function(e){var t=d("img");return t.crossOrigin="Anonymous",t.onload=e,t.onerror=function(){t.src=o()},t.src=o(),t}(function(){i.canvasCtx.drawImage(n,0,0,c,u),i.blockCtx.drawImage(n,0,0,c,u);var e=i.y-20+2,t=i.blockCtx.getImageData(i.x,e,l,l);i.block.width=l,i.blockCtx.putImageData(t,0,e)});this.img=n}},{key:"draw",value:function(){this.x=t(72,238),this.y=t(30,83),i(this.canvasCtx,"fill",this.x,this.y),i(this.blockCtx,"clip",this.x,this.y)}},{key:"clean",value:function(){this.canvasCtx.clearRect(0,0,c,u),this.blockCtx.clearRect(0,0,c,u),this.block.width=c}},{key:"bindEvents",value:function(){var s=this;this.el.onselectstart=function(){return!1},this.refreshIcon.onclick=function(){s.reset()};var a=void 0,r=void 0,l=[],o=!1;this.slider.addEventListener("mousedown",function(e){a=e.x,r=e.y,o=!0}),document.addEventListener("mousemove",function(e){if(!o)return!1;var t=e.x-a,i=e.y-r;if(t<0||c<=38+t)return!1;s.slider.style.left=t+"px";var n=250/270*t;s.block.style.left=n+"px",h(s.sliderContainer,"sliderContainer_active"),s.sliderMask.style.width=t+"px",l.push(i)}),document.addEventListener("mouseup",function(e){if(!o)return!1;if(o=!1,e.x==a)return!1;!function(e,t){e.classList.remove(t)}(s.sliderContainer,"sliderContainer_active"),s.trail=l;var t=s.verify(),i=t.spliced,n=t.TuringTest;i?n?(h(s.sliderContainer,"sliderContainer_success"),s.success&&s.success()):(h(s.sliderContainer,"sliderContainer_fail"),s.text.innerHTML="再试一次",s.reset()):(h(s.sliderContainer,"sliderContainer_fail"),s.fail&&s.fail(),setTimeout(function(){s.reset()},1e3))})}},{key:"verify",value:function(){var e=this.trail,t=e.reduce(f)/e.length,i=e.map(function(e){return e-t}),n=Math.sqrt(i.map(v).reduce(f)/e.length),s=parseInt(this.block.style.left);return{spliced:Math.abs(s-this.x)<10,TuringTest:t!==n}}},{key:"reset",value:function(){this.sliderContainer.className="sliderContainer",this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.img.src=o(),this.draw()}}]),n}();e.jigsaw={init:function(e,t,i){new n(e,t,i).init()}}}(window);